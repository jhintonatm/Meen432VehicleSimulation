%%% PROJECT 2 PARAMETERS %%% 
% The following parameters are to be used for Project 2, and some will be
% used for Project 3 which will be commented out at the bottom of the
% script. 

% Vehicle Parameters
carData.Inertia = 1600; % kg m^2  -  Car Inertia
carData.Mass = 1000; % kg      -  Car Mass 


% Initial Conditions
carData.init.X0 = 0;        % m - Initial X Position of the Car
carData.init.Y0 = 0;        % m - Initial Y Position of the Car
carData.init.vx0 = 0.1;     % m/s - Initial Velocity in X of the Car
carData.init.vy0 = 0;       % m/s - Initial Velocity in Y of the Car
carData.init.omega0 = 0;    % rad/s - Initial Yaw Rate of the Car
carData.init.psi0 = 0;      % rad - Initial Heading of the Car


% Vehicle Tire Information 
carData.Calpha_f = 40000; % N/rad - Front Tire Coefficient (slope)
carData.Calpha_r = 40000; % N/rad - Rear Tire Coefficient (slope)
carData.Fyfmax = 40000*1/180*pi; % N - Max Front Tire Force
carData.Fyrmax = 40000*1/180*pi; % N - Max Rear Tire Force
carData.lr = 1.5; % m - Distance from CG to rear axis
carData.lf = 1.0; % m - Distance from CG to front axis
carData.radius = 0.3; % m - Radius of tires


track_radius = 200;
carData.understeerCoeff = ... % Understeering Coefficient 
    carData.Mass / ((carData.lr + carData.lf) * track_radius) ...
      * (carData.lr / carData.Calpha_f - ...
         carData.lf / carData.Calpha_r);


carData.maxAlpha = 4 / 180 * pi; % Max Alpha Angle for Tires


carData.vxd = 15; % m/s - Desired Velocity in X
carData.vx_threshold1 = 0.1; % m/s - Threshold for Velocity in X


%%% PROJECT 3 EXTRA INFORMATION %%%
% Longitudinal Dynamics Properties
% carData.C0 = 0.0041;         % N - Static Friction Coefficient 
% carData.C1 = 0.000066;       % N/(m/s) - Rolling Friction Coefficient

% Parameters for Calculation of C2
% Rho =1.225;          % Kg/m^3 - Density of Atmosphere
% A  = 2.32;           % m^2 - Projected Area
% Cd = 0.36;           % unitless - Drag Coefficient
% carData.C2 = 0.5*Rho*A*Cd; % N/(m/s)^2 - Aerodynamic Drag Coefficient

carDataBus = Simulink.Bus.createObject(carData);


%%% PROJECT 3 PARAMETERS %%% YOU SHOULD BE USING ONLY THESE PARAMETERS FOR
%%% THE CORRESPONDING VARIABLES. 

%Vehicle Level Parameters
datCar.I = 2000; %kg m^2  -  Car Inertia
datCar.m = 1600; %kg      -  Car Mass 

%Vehicle Drag Coefficients

datCar.C0 = 0.0041;         %in N
datCar.C1 = 0.000066;       %in N/(m/s)
% parameters for calculation of C2
Rho =1.225;          %Kg/m^3
A  = 2.6;           % m^2 (projected area)
Cd = 0.36;           %Aerodynamic drag coefficient
datCar.C2 = 0.5*Rho*A*Cd;   % in N/(m/s)^2

% Vehicle Initial Conditions

datCar.init.X0 = 0;       % Initial X position of the vehicle (track start)
datCar.init.Y0 = 0;       % Initial Y position of the vehicle (track start)
datCar.init.vx0 = 0.001;  % Initial velocity of vehicle in body x axis (m/s)
datCar.init.vy0 = 0;      % Initial velocity of vehilce in body y axis (m/s)
datCar.init.omega0 = 0;   % Initial yaw rate of vehicle (rad/s)
datCar.init.psi0 = 0;     % Initial yaw of vehicle (rad)

%Tire Data
datCar.Calpha_f = 40000; % N/rad  initial tire stiffness - front
datCar.Calpha_r = 40000; % N/rad  initial tire stiffness - rear
datCar.Fyfmax = 40000*2/180*pi;  % maximum front tire force achievable (N)
datCar.Fyrmax = 40000*2/180*pi;  % maximum rear tire force achievable (N)
datCar.lr = 1.5; % m  distance of center of mass to front axle
datCar.lf = 1.0; % m  distance of center of mass to rear axle
datCar.radius = 0.3; %m  tire radius
datCar.maxAlpha = 2 / 180 * pi;  % maximum alpha value to be used in calc (rad)
datCar.Iw = 0.5*7*(datCar.radius^2);

datCar.C_lambda = 50; % longitudinal stiffness (N/Kg)
datCar.lambda_max = 0.1; %maximum tire slip ratio before saturation
datCar.tire_mu = 1.0;


datCar.init.omega0 = datCar.init.vx0 / datCar.radius;

%Transmission Data
datCar.gearRatio1 = 10.0;
datCar.gearRatio2 = 3.0;
datCar.gearRatio3 = 1.0;

datCar.FDRatio = 7.5;
datCar.FDeta = 0.95;

%Brake
datCar.maxBrakeTorque = 50000;

% track Data
track.radius = 200; %m radius of curved sections
track.width = 15;   %m width of track
track.l_st = 900;   %m length of straightaways

scaleFactor = 0.75;
%Electric Motor Data - corresponds to the HVH250-090 Electric Motor
datMotor.rpm =       [0,  1000,2000,3000,4000,5000,6000,7000,8000,9000,10000,11000, 12000];
datMotor.maxtorque = [0, 0, 0, 0, 0, 0,  0,  0,  0,  0,   0,   0,     0;
             280, 280, 280, 220, 160, 110,  95,  75,  60,  55,   50,   40,     0;
             280, 280, 275, 255, 240, 180, 140, 125,  95,  75,   70,   50,     0;
             280, 280, 275, 260, 250, 220, 180, 150, 125, 100,   80,   70,     0;
             280, 280, 275, 260, 250, 230, 200, 175, 140, 120,  100,   75,     0] * scaleFactor;
datMotor.vbus = [250, 350, 500, 600, 700]*scaleFactor;

datMotor.eta_torque = [0:25:325] * 280/325 * scaleFactor;
datMotor.eta_speed = [0:500:10000];
datMotor.eta_speed(1) = 10;
datMotor.eta_val = [0.740000000000000,0.740000000000000,0.740000000000000,0.740000000000000,0.740000000000000,0.740000000000000,0.740000000000000,0.740000000000000,0.740000000000000,0.740000000000000,0.740000000000000,0.740000000000000,0.740000000000000,0.740000000000000,0.740000000000000,0.740000000000000,0.740000000000000,0.740000000000000,0.740000000000000,0.740000000000000,0.740000000000000;
    0.860000000000000,0.940000000000000,0.96000000000000,0.940000000000000,0.940000000000000,0.940000000000000,0.920000000000000,0.920000000000000,0.900000000000000,0.900000000000000,0.880000000000000,0.860000000000000,0.860000000000000,0.860000000000000,0.860000000000000,0.840000000000000,0.820000000000000,0.800000000000000,0.780000000000000,0.760000000000000,0.740000000000000;
    0.840000000000000,0.940000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.960000000000000,0.940000000000000,0.940000000000000,0.940000000000000,0.940000000000000,0.920000000000000,0.920000000000000,0.920000000000000,0.920000000000000,0.920000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.880000000000000,0.880000000000000;
    0.840000000000000,0.920000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.940000000000000,0.940000000000000,0.940000000000000,0.940000000000000,0.940000000000000,0.940000000000000,0.920000000000000,0.920000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.880000000000000;
    0.820000000000000,0.900000000000000,0.940000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.940000000000000,0.940000000000000,0.940000000000000,0.920000000000000,0.900000000000000,0.900000000000000,0.880000000000000,0.880000000000000,0.880000000000000;
    0.820000000000000,0.880000000000000,0.940000000000000,0.940000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.940000000000000,0.940000000000000,0.920000000000000,0.920000000000000,0.900000000000000,0.900000000000000,0.880000000000000,0.860000000000000,0.860000000000000;
    0.800000000000000,0.880000000000000,0.920000000000000,0.940000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.940000000000000,0.940000000000000,0.920000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000;
    0.800000000000000,0.860000000000000,0.900000000000000,0.940000000000000,0.940000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.940000000000000,0.920000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000;
    0.780000000000000,0.860000000000000,0.900000000000000,0.920000000000000,0.940000000000000,0.940000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.96000000000000,0.940000000000000,0.920000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000;
    0.780000000000000,0.860000000000000,0.900000000000000,0.920000000000000,0.920000000000000,0.940000000000000,0.940000000000000,0.940000000000000,0.96000000000000,0.940000000000000,0.940000000000000,0.920000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000;
    0.760000000000000,0.860000000000000,0.880000000000000,0.900000000000000,0.920000000000000,0.940000000000000,0.940000000000000,0.940000000000000,0.940000000000000,0.940000000000000,0.920000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000;
    0.740000000000000,0.840000000000000,0.860000000000000,0.900000000000000,0.920000000000000,0.920000000000000,0.940000000000000,0.940000000000000,0.940000000000000,0.940000000000000,0.920000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.9000000000000000;
    .740000000000000,0.840000000000000,0.860000000000000,0.880000000000000,0.900000000000000,0.920000000000000,0.920000000000000,0.940000000000000,0.920000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000;
    0.720000000000000,0.820000000000000,0.860000000000000,0.880000000000000,0.900000000000000,0.900000000000000,0.920000000000000,0.920000000000000,0.920000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000,0.900000000000000];
datMotor.eta_val = datMotor.eta_val .* datMotor.eta_val;

datMotor.inertia = 0.5; % Kg-m^2

% Conversion
mph2mps = 1600/3600;

figure
[C,h] = contour( datMotor.eta_speed, datMotor.eta_torque, datMotor.eta_val);
clabel(C,h)
h.LineColor='k'
xlabel('Speed (rpm)');
ylabel('Torque (Nm)');
title('Efficiency (%) Contour Maps - Project 3');
grid
hold on
plot(datMotor.rpm,datMotor.maxtorque,'--')

%Battery Data

datBat.SOC=[0, 0.01,   .1,  .2,  .3,  .4,  .5,  .6, .7,  .8,  .9,   1] % soc
datBat.OCV=[0, 3.1,3.55,3.68,3.74,3.76,3.78,3.85,3.9,3.95,4.08,4.15]  % OCV per cell
datBat.Rint=0.1695; % internal resistance per cell
datBat.C = 150 % Amp hr total battery capacity
datBat.numSeries = 96;
datBat.numParallel = 74;

figure
plot(datBat.SOC,datBat.OCV)
xlabel('Cell State of Charge ')
ylabel('Cell Open Circuit Volage (OCV) - Volts')
title('Lithium Ion Cell Characteristic - Project 3')
grid



